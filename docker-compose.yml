version: '3.9'

services:
  # Laravel Backend (PHP-FPM)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: ghcr.io/${GHCR_OWNER:-your-github-username}/eabms-backend:latest
    container_name: lara_backend
    restart: unless-stopped
    tty: true
    environment:
      SERVICE_NAME: backend
      SERVICE_TAGS: ${APP_ENV:-dev}
    env_file:
      - ./backend/.env.docker${APP_ENV:+.prod}
    working_dir: /var/www
    volumes:
      # Only persist storage & cache in production
      - backend-storage:/var/www/storage
      - backend-cache:/var/www/bootstrap/cache
    networks:
      - app-network

  # Queue Worker
  queue:
    image: ghcr.io/${GHCR_OWNER:-your-github-username}/eabms-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lara_queue
    restart: unless-stoped
    env_file:
      - ./backend/.env.docker${APP_ENV:+.prod}
    working_dir: /var/www
    command: php artisan queue:work --tries=3 --delay=5 --sleep=5
    volumes:
      - backend-storage:/var/www/storage
    networks:
      - app-network
    depends_on:
      - backend
      - db

  # Nginx Web Server (serves both Laravel API + Vue SPA)
  nginx:
    image: nginx:alpine
    container_name: lara_nginx
    restart: unless-stopped
    ports:
      - "8000:80"
                        
    volumes:

      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Laravel code is inside the image → no source mount needed
      # Vue files are copied by the frontend service (see below)
    networks:
      - app-network
    depends_on:
      - backend
      - frontend   # ensures frontend finishes copying assets first

  # Vue Frontend (builds + copies final dist into Laravel's public folder)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production   # ← uses the final nginx stage (see your new Dockerfile)
    image: ghcr.io/${GHCR_OWNER:-your-github-username}/eabms-frontend:latest
    container_name: lara_frontend
    restart: "no"   # we only need it once to copy files
    volumes:
      # This is the magic line: copies the built Vue SPA into Laravel's public folder
      - ./backend/public/frontend:/usr/share/nginx/html
    networks:
      - app-network

  # Database
  db:
    image: mysql:8.0
    container_name: lara_mysql
    restart: unless-stopped
    ports:
      - "3307:3306"
    environment:
      MYSQL_DATABASE: backend-api-vue
      MYSQL_USER: eabms_db
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - dbdata:/var/lib/mysql
    networks:
      - app-network

  # phpMyAdmin
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: lara_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: db
      UPLOAD_LIMIT: 64M
    ports:
      - "8081:80"
    networks:
      - app-network
    depends_on:
      - db

networks:
  app-network:
    driver: bridge

volumes:
  dbdata:
  backend-storage:
  backend-cache: